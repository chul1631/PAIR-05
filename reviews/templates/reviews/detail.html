{% extends 'base.html' %} 

{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

{% block content %} 
<p>{{ review.title }}</p>
<p>{{ review.content }}</p>
<a href="{% url 'reviews:update' review.pk %}">글수정</a>
<a href="{% url 'reviews:delete' review.pk %}">글삭제</a>
<hr>
{% if review.image %}
<img src="{{ review.image.url }}" alt="{{ review.image }}" width="400" height="300">
{% endif %}

<hr>

<!-- Comment-Form -->
<form id="comment-form" data-review-id="{{ review.pk }}">
  {% csrf_token %}
  {% bootstrap_form comment_form %}
  {% bootstrap_button button_type="submit" content="OK" %}
</form>

<hr>
<div id="comments">
  {% for comment in comments %}
    <p>{{ comment.user.username }}: {{ comment.content }}</p>
    
    {% if request.user == comment.user %}
    <form id="comment-delete" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
      {% csrf_token %}
      {% bootstrap_button button_type="submit" content="delete" %}
    </form>
    {% endif %}
    <hr>
  {% endfor %}
</div>

{% endblock content %}


{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const commentForm = document.querySelector('#comment-form')
  const commentDelete = document.querySelector('#comment-delete')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  commentForm.addEventListener('submit', function(event) {
    event.preventDefault();
    const reviewId = event.target.dataset.reviewId
    axios({
      method: 'post',
      url: `/reviews/${reviewId}/comment/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(commentForm)
    })
      .then(response => {
        console.log(response.data)
        const comments = document.querySelector('#comments')
        const p = document.createElement('p')
        p.innerText = `${response.data.content}`
        const hr = document.createElement('hr')
        comments.append(p, hr)
        commentForm.reset()
      })
  })

  commentDelete.addEventListener('submit', function(event) {
    event.preventDefault();
    const reviewId = event.target.dataset.reviewId
    const commentId = event.target.dataset.commentId
    axios({
      method: 'post',
      url: `/reviews/${reviewId}/comment/${commentId}/delete/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then(response => {
        console.log(response.data)
        const comment = response.data.comment
        const p = document.querySelector('#p')
        const hr = document.querySelector('#hr')
        if (comment === false) {
          p.remove()
          hr.remove()
          commentDelete.remove()
        }
      })
      .catch((error) => {
        console.log(error.response)
      })
  })
</script>
{% endblock script %}
  